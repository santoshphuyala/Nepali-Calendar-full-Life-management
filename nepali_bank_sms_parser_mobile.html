<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Secure SMS Parser with IndexedDB & AES-256 Encryption">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SMS Parser">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>SMS Parser Pro - Secure IndexedDB v2.1</title>
    
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU01TIFBhcnNlciBQcm8iLCJzaG9ydF9uYW1lIjoiU01TIFBhcnNlciIsImRlc2NyaXB0aW9uIjoiU2VjdXJlIFNNUyBQYXJzZXIgd2l0aCBJbmRleGVkREIiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBmMTcyYSIsInRoZW1lX2NvbG9yIjoiIzBmMTcyYSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQtcHJpbWFyeSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInJTNFJTNDcmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgZmlsbD0nJTIzMGYxNzJhJyUyRiUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBkb21pbmFudC1iYXNlbGluZT0nbWlkZGxlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzI4MCclM0Xwn5SQJTNDJTJGdGV4dCUzRSUzQyUyRnN2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0=">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230f172a'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='50'%3Eüîê%3C/text%3E%3C/svg%3E">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../conversion.js"></script>
    <script src="../nepali-date-picker.js"></script>
    
    <style>
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #06b6d4;
            --accent-dark: #0891b2;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --indigo: #6366f1;
            --orange: #f97316;
            --light-bg: #f1f5f9;
            --lighter-bg: #f8fafc;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 10px 15px rgba(15, 23, 42, 0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #312e81 100%);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* ==================== LOADING SCREEN ==================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #312e81 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255,255,255,0.8);
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .loading-subtext {
            color: rgba(255,255,255,0.5);
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        /* ==================== LOCK SCREEN ==================== */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #312e81 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
            padding-top: calc(2rem + var(--safe-top));
            padding-bottom: calc(2rem + var(--safe-bottom));
        }

        .lock-screen.hidden {
            display: none;
        }

        .lock-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: lockPulse 2s infinite;
        }

        @keyframes lockPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .lock-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .lock-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .pin-display {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            background: transparent;
            transition: all 0.2s;
        }

        .pin-dot.filled {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .pin-dot.error {
            background: var(--danger);
            border-color: var(--danger);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            max-width: 280px;
            width: 100%;
        }

        .pin-key {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .pin-key:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--accent);
        }

        .pin-key:active {
            transform: scale(0.95);
            background: var(--accent);
        }

        .pin-key.action {
            font-size: 1.2rem;
            border-color: transparent;
            background: transparent;
        }

        .pin-key.action:hover {
            color: var(--accent);
        }

        .pin-key.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .lock-error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
            min-height: 1.5rem;
        }

        .lock-footer {
            margin-top: 2rem;
            text-align: center;
        }

        .lock-footer-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
        }

        .lock-footer-btn:hover {
            color: var(--accent);
        }

        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 1.5rem;
        }

        .setup-step {
            display: none;
            text-align: center;
        }

        .setup-step.active {
            display: block;
        }

        .setup-progress {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .setup-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }

        .setup-progress-dot.active {
            background: var(--accent);
        }

        .setup-progress-dot.done {
            background: var(--success);
        }

        /* ==================== MAIN APP ==================== */
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(135deg, #f1f5f9 0%, #e0e7ff 50%, #fce7f3 100%);
            display: none;
        }

        .app-container.visible {
            display: flex;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 0.9rem 1rem;
            padding-top: calc(0.9rem + var(--safe-top));
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .app-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .app-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .header-badges {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.15rem;
        }

        .header-badge {
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.55rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-secure { background: var(--success); }
        .badge-idb { background: var(--purple); }
        .badge-encrypted { background: linear-gradient(135deg, var(--orange), var(--pink)); }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .header-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
        }

        .header-stat { text-align: center; }
        .header-stat-value { font-weight: 700; font-size: 0.85rem; }
        .header-stat-label { opacity: 0.8; font-size: 0.6rem; }

        /* Main */
        .app-main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 0.75rem;
            padding-bottom: calc(0.75rem + var(--safe-bottom));
        }

        /* Section */
        .section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i { color: var(--accent); }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 0.2rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .tabs-container::-webkit-scrollbar { display: none; }

        .tab-btn {
            padding: 0.5rem 0.8rem;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-badge {
            background: var(--purple);
            color: white;
            padding: 0.1rem 0.35rem;
            border-radius: 8px;
            font-size: 0.6rem;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Forms */
        .form-group { margin-bottom: 0.75rem; }

        .form-label {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .form-control {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        textarea.form-control {
            min-height: 80px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.55rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; }
        .btn-secondary { background: var(--light-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-success { background: linear-gradient(135deg, var(--success), var(--success-dark)); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), var(--danger-dark)); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), var(--warning-dark)); color: white; }
        .btn-purple { background: linear-gradient(135deg, var(--purple), var(--indigo)); color: white; }
        .btn-ghost { background: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--light-bg); }

        .btn-sm { padding: 0.4rem 0.7rem; font-size: 0.75rem; }
        .btn-lg { padding: 0.7rem 1.25rem; font-size: 0.95rem; }
        .btn-block { width: 100%; }
        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 50%; }

        .btn-group { display: flex; gap: 0.4rem; flex-wrap: wrap; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .stat-card {
            background: var(--light-bg);
            padding: 0.6rem;
            border-radius: var(--radius-md);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.income::before { background: var(--success); }
        .stat-card.expense::before { background: var(--danger); }
        .stat-card.balance::before { background: linear-gradient(90deg, var(--accent), var(--purple)); }
        .stat-card.storage::before { background: var(--purple); }

        .stat-label { font-size: 0.6rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 0.95rem; font-weight: 700; margin-top: 0.15rem; }
        .stat-value.income { color: var(--success); }
        .stat-value.expense { color: var(--danger); }
        .stat-value.storage { color: var(--purple); }

        /* Transaction List */
        .transaction-list { max-height: 350px; overflow-y: auto; }

        .transaction-item {
            display: flex;
            gap: 0.6rem;
            padding: 0.65rem;
            background: var(--lighter-bg);
            border-radius: var(--radius-md);
            margin-bottom: 0.4rem;
            border-left: 3px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .transaction-item:hover {
            background: var(--light-bg);
            transform: translateX(2px);
        }

        .transaction-item.income { border-left-color: var(--success); }
        .transaction-item.expense { border-left-color: var(--danger); }

        .transaction-item.selected {
            background: rgba(6, 182, 212, 0.1);
            border-left-color: var(--accent);
        }

        .transaction-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .transaction-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .transaction-item.income .transaction-icon {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .transaction-item.expense .transaction-icon {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .transaction-info { flex: 1; min-width: 0; }
        .transaction-title { font-weight: 600; font-size: 0.85rem; }
        .transaction-meta { font-size: 0.7rem; color: var(--text-secondary); display: flex; gap: 0.5rem; margin-top: 0.15rem; }

        .transaction-right { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; }
        .transaction-amount { font-weight: 700; font-size: 0.95rem; white-space: nowrap; }
        .transaction-amount.income { color: var(--success); }
        .transaction-amount.expense { color: var(--danger); }

        .transaction-actions { display: flex; gap: 0.2rem; opacity: 0; transition: opacity 0.2s; }
        .transaction-item:hover .transaction-actions { opacity: 1; }
        .transaction-actions .btn-icon { width: 26px; height: 26px; font-size: 0.7rem; }

        /* Batch Actions */
        .batch-actions {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 0.75rem 1rem;
            padding-bottom: calc(0.75rem + var(--safe-bottom));
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            border-top: 2px solid var(--border-color);
        }

        .batch-actions.show { display: block; }

        .batch-actions-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-count { font-weight: 700; color: var(--accent); }

        /* Alert */
        .alert-box {
            position: fixed;
            top: calc(var(--safe-top) + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 0.6rem 1rem;
            border-radius: var(--radius-lg);
            display: none;
            align-items: center;
            gap: 0.4rem;
            z-index: 2000;
            max-width: 90%;
            box-shadow: var(--shadow-lg);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .alert-box.show { display: flex; animation: alertSlide 0.3s ease; }
        .alert-box.success { background: var(--success); color: white; }
        .alert-box.error { background: var(--danger); color: white; }
        .alert-box.warning { background: var(--warning); color: white; }
        .alert-box.info { background: var(--accent); color: white; }

        @keyframes alertSlide {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            padding: 0.75rem;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.25rem;
            max-width: 500px;
            width: 100%;
            margin-top: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.05rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-title i { color: var(--accent); }

        .modal-close {
            background: var(--light-bg);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-close:hover { background: var(--border-color); color: var(--danger); }
        .modal-footer { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }

        /* Info Box */
        .info-box {
            padding: 0.6rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.6rem;
            font-size: 0.8rem;
            display: flex;
            align-items: flex-start;
            gap: 0.4rem;
        }

        .info-box i { flex-shrink: 0; margin-top: 0.1rem; }
        
        .info-box.secure {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--success);
            color: var(--success-dark);
        }

        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--warning);
            color: var(--warning-dark);
        }

        .info-box.idb {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--purple);
            color: var(--purple);
        }

        /* Security Settings */
        .security-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--light-bg);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
        }

        .security-option-info { flex: 1; }

        .security-option-title {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .security-option-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.15rem;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle.active { background: var(--success); }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .toggle.active::after { left: 22px; }

        /* Parse Preview */
        .parse-preview {
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-top: 0.6rem;
            display: none;
        }

        .parse-preview.show { display: block; }

        .parse-title {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .parse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.4rem;
        }

        .parse-item {
            background: white;
            padding: 0.4rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .parse-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; }
        .parse-value { font-weight: 600; font-size: 0.8rem; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-secondary);
        }

        .empty-state i { font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem; display: block; }

        /* Auto-lock Timer */
        .auto-lock-indicator {
            position: fixed;
            bottom: calc(1rem + var(--safe-bottom));
            right: 1rem;
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            display: none;
            align-items: center;
            gap: 0.4rem;
            z-index: 500;
        }

        .auto-lock-indicator.show { display: flex; }

        /* Storage Info */
        .storage-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05));
            border: 1px solid var(--purple);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .storage-info-title {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--purple);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
        }

        .storage-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .storage-stat {
            text-align: center;
        }

        .storage-stat-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        .storage-stat-label {
            color: var(--text-secondary);
            font-size: 0.65rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }

        /* Transaction Table */
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        
        .transaction-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .transaction-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }
        
        .transaction-table tr:hover {
            background: var(--bg-secondary);
        }
        
        .table-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .table-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            min-width: auto;
        }
        
        .table-actions .btn-icon {
            padding: 0.25rem;
            font-size: 0.65rem;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .header-stats { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
            .pin-key { width: 60px; height: 60px; font-size: 1.3rem; }
            .transaction-table { font-size: 0.65rem; }
            .transaction-table th,
            .transaction-table td { padding: 0.4rem; }
            .table-actions .btn { padding: 0.2rem 0.3rem; font-size: 0.6rem; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Database...</div>
        <div class="loading-subtext">Setting up IndexedDB storage</div>
    </div>

    <!-- Lock Screen -->
    <div id="lockScreen" class="lock-screen hidden">
        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-step">
            <div class="lock-icon">üîê</div>
            <div class="lock-title">Secure Your Data</div>
            <div class="lock-subtitle">Create a 4-digit PIN to protect your transactions</div>
            
            <div class="setup-progress">
                <div class="setup-progress-dot active" id="step1Dot"></div>
                <div class="setup-progress-dot" id="step2Dot"></div>
            </div>
            
            <div class="lock-subtitle" id="setupPrompt">Enter new PIN</div>
            <div class="pin-display" id="setupPinDisplay">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            
            <div class="pin-keypad" id="setupKeypad"></div>
            <div class="lock-error" id="setupError"></div>
            
            <div class="security-badge">
                <i class="fas fa-database"></i>
                IndexedDB + AES-256
            </div>
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="setup-step">
            <div class="lock-icon">üîí</div>
            <div class="lock-title">SMS Parser Pro</div>
            <div class="lock-subtitle">Enter your PIN to unlock</div>
            
            <div class="pin-display" id="loginPinDisplay">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>
            
            <div class="pin-keypad" id="loginKeypad"></div>
            <div class="lock-error" id="loginError"></div>
            
            <div class="lock-footer">
                <button class="lock-footer-btn" onclick="showResetOption()">
                    <i class="fas fa-question-circle"></i> Forgot PIN?
                </button>
            </div>
            
            <div class="security-badge">
                <i class="fas fa-lock"></i>
                Data Encrypted
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <!-- Alert -->
        <div id="alertBox" class="alert-box">
            <i class="fas fa-info-circle"></i>
            <span id="alertMessage"></span>
        </div>

        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="app-logo">üîê</div>
                    <div>
                        <div class="app-title">SMS Parser Pro</div>
                        <div class="header-badges">
                            <span class="header-badge badge-idb">IDB</span>
                            <span class="header-badge badge-encrypted">Local Storage</span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <!-- Export Dropdown -->
                    <div class="dropdown-container" style="position: relative; display: inline-block;">
                        <button class="header-btn" onclick="toggleDropdown('smsExportMenu')" title="Export SMS Data">
                            <i class="fas fa-download"></i>
                        </button>
                        <div class="dropdown-menu" id="smsExportMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; z-index: 1000;">
                            <button class="dropdown-item" onclick="exportSMSData('json')" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.8rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--light-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                                üìÑ Export as JSON
                            </button>
                            <button class="dropdown-item" onclick="exportSMSData('excel')" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.8rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--light-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                                üìä Export as Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Import Dropdown -->
                    <div class="dropdown-container" style="position: relative; display: inline-block;">
                        <button class="header-btn" onclick="toggleDropdown('smsImportMenu')" title="Import SMS Data">
                            <i class="fas fa-upload"></i>
                        </button>
                        <div class="dropdown-menu" id="smsImportMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; z-index: 1000;">
                            <button class="dropdown-item" onclick="document.getElementById('smsImportJson').click()" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.8rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--light-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                                üìÑ Import from JSON
                            </button>
                            <button class="dropdown-item" onclick="document.getElementById('smsImportExcel').click()" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.8rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--light-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                                üìä Import from Excel
                            </button>
                            <input type="file" id="smsImportJson" accept=".json" style="display: none;" onchange="importSMSData('json', this)">
                            <input type="file" id="smsImportExcel" accept=".xlsx,.xls" style="display: none;" onchange="importSMSData('excel', this)">
                        </div>
                    </div>
                    
                    <button class="header-btn" onclick="updateTransactionsInTracker()" title="Update Transactions in Tracker">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="header-btn" onclick="openTracker()" title="Open Tracker">
                        <i class="fas fa-chart-pie"></i>
                    </button>
                    <button class="header-btn" onclick="openSettings()" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Storage Info -->
            <div class="storage-info">
                <div class="storage-info-title">
                    <i class="fas fa-database"></i> IndexedDB Storage
                </div>
                <div class="storage-stats">
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="dbTransactions">0</div>
                        <div class="storage-stat-label">Transactions</div>
                    </div>
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="dbPatterns">0</div>
                        <div class="storage-stat-label">Patterns</div>
                    </div>
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="dbSize">0 KB</div>
                        <div class="storage-stat-label">Size</div>
                    </div>
                </div>
            </div>

            <!-- Add Transaction Section -->
            <section class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-plus-circle"></i> Add Transaction
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="readClipboard()">
                        <i class="fas fa-clipboard"></i>
                    </button>
                </div>

                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchTab(this, 'tab-paste')">
                        <i class="fas fa-paste"></i> SMS
                    </button>
                    <button class="tab-btn" onclick="switchTab(this, 'tab-bulk')">
                        <i class="fas fa-layer-group"></i> Bulk
                    </button>
                    <button class="tab-btn" onclick="switchTab(this, 'tab-test')">
                        <i class="fas fa-flask"></i> Test
                    </button>
                    <button class="tab-btn" onclick="switchTab(this, 'tab-table')">
                        <i class="fas fa-table"></i> Table
                    </button>
                    <button class="tab-btn" onclick="switchTab(this, 'tab-manual')">
                        <i class="fas fa-edit"></i> Manual
                    </button>
                </div>

                <div id="tab-paste" class="tab-content active">
                    <div class="form-group">
                        <textarea id="smsInput" class="form-control" placeholder="Paste SMS here..." oninput="previewSMS()"></textarea>
                    </div>
                    <div id="parsePreview" class="parse-preview"></div>
                    <div class="btn-group" style="margin-top: 0.6rem;">
                        <button class="btn btn-success" onclick="processSMS()">
                            <i class="fas fa-check"></i> Add
                        </button>
                        <button class="btn btn-purple" onclick="openTraining()">
                            <i class="fas fa-brain"></i> Train
                        </button>
                        <button class="btn btn-secondary" onclick="clearInput()">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>

                    <!-- Training Container -->
                    <div id="trainingContainer" class="training-container" style="display: none; margin-top: 0.75rem; padding: 0.9rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.04)); border: 2px solid var(--purple); border-radius: var(--radius-lg);">
                        <div style="font-weight: 700; color: var(--purple); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-graduation-cap"></i> Training Mode
                        </div>
                        <div class="field-selector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 0.3rem; margin-bottom: 0.6rem;">
                            <button class="field-btn" onclick="selectField('amount', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">üí∞ Amount</button>
                            <button class="field-btn" onclick="selectField('credit', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">‚¨áÔ∏è Credit</button>
                            <button class="field-btn" onclick="selectField('debit', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">‚¨ÜÔ∏è Debit</button>
                            <button class="field-btn" onclick="selectField('bank', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">üè¶ Bank</button>
                            <button class="field-btn" onclick="selectField('date', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">üìÖ Date</button>
                            <button class="field-btn" onclick="selectField('remarks', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">üìù Remarks</button>
                            <button class="field-btn" onclick="selectField('account', this)" style="padding: 0.4rem; border: 2px solid var(--border-color); border-radius: var(--radius-sm); background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer;">üè¶ Account</button>
                        </div>
                        <div id="trainingSmsBox" style="background: white; padding: 0.6rem; border-radius: var(--radius-md); border: 2px solid var(--border-color); font-family: monospace; font-size: 0.8rem; line-height: 1.7; margin-bottom: 0.6rem; max-height: 120px; overflow-y: auto;"></div>
                        <div class="form-group">
                            <input type="text" id="patternName" class="form-control" placeholder="Pattern name (e.g., Sanima Deposit)">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="savePattern()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelTraining()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div id="tab-bulk" class="tab-content">
                    <div class="form-group">
                        <textarea id="bulkInput" class="form-control" rows="6" placeholder="Multiple SMS separated by blank lines..."></textarea>
                    </div>
                    <button class="btn btn-warning btn-block" onclick="processBulk()">
                        <i class="fas fa-bolt"></i> Process All
                    </button>
                </div>

                <div id="tab-test" class="tab-content">
                    <div class="info-box secure">
                        <i class="fas fa-flask"></i>
                        <span>Test the enhanced SMS parser with real Nepali bank examples</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Test SMS Examples</label>
                        <select id="testExample" class="form-control" onchange="loadTestExample()">
                            <option value="">Select an example...</option>
                            <option value="nabil-credit">Nabil Bank - Credit</option>
                            <option value="nic-debit">NIC Asia - Debit</option>
                            <option value="esewa-payment">eSewa - Payment</option>
                            <option value="khalti-transfer">Khalti - Transfer</option>
                            <option value="global-deposit">Global IME - Deposit</option>
                            <option value="sanima-withdraw">Sanima - Withdrawal</option>
                            <option value="himalayan-transfer">Himalayan - Transfer</option>
                            <option value="nmb-purchase">NMB - Purchase</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <textarea id="testSmsInput" class="form-control" rows="4" placeholder="Or paste your own SMS to test..." oninput="testParseSMS()"></textarea>
                    </div>
                    
                    <div id="testParsePreview" class="parse-preview"></div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="testProcessSMS()">
                            <i class="fas fa-check"></i> Test Parse
                        </button>
                        <button class="btn btn-secondary" onclick="clearTest()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </div>

                <div id="tab-table" class="tab-content">
                    <div class="info-box secure">
                        <i class="fas fa-table"></i>
                        <span>View all transactions in tabular format with edit and delete options</span>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <input type="text" id="tableSearchInput" class="form-control" placeholder="üîç Search transactions..." oninput="renderTable()">
                        <select id="tableFilterType" class="form-control" onchange="renderTable()">
                            <option value="all">All Types</option>
                            <option value="credit">Income</option>
                            <option value="debit">Expense</option>
                        </select>
                        <button class="btn btn-danger" onclick="confirmClearAllTransactions()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    
                    <div class="table-container" style="background: white; border-radius: var(--radius-md); border: 1px solid var(--border-color); overflow: hidden;">
                        <table id="transactionTable" class="transaction-table">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Date</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Bank</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Account</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Type</th>
                                    <th style="padding: 0.75rem; text-align: right; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Amount</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Remarks</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Table rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="tableEmptyState" class="empty-state" style="display: none; text-align: center; padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 0.5rem;"></i>
                        <p style="color: var(--text-secondary);">No transactions found</p>
                    </div>
                </div>

                    <div id="tab-manual" class="tab-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" id="manualAmount" class="form-control" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select id="manualType" class="form-control">
                                <option value="credit">Income</option>
                                <option value="debit">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Bank</label>
                            <select id="manualBank" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date (BS)</label>
                            <input type="text" id="manualDate" class="form-control" placeholder="YYYY/MM/DD">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" id="manualAccount" class="form-control" placeholder="A/C No.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Remarks</label>
                            <input type="text" id="manualRemarks" class="form-control" placeholder="Notes...">
                        </div>
                    </div>
                    <button class="btn btn-success btn-block" onclick="addManual()">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="section">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i> Summary
                </div>
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-label">Income</div>
                        <div class="stat-value income" id="totalIncome">0</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-label">Expense</div>
                        <div class="stat-value expense" id="totalExpense">0</div>
                    </div>
                    <div class="stat-card balance">
                        <div class="stat-label">Balance</div>
                        <div class="stat-value" id="netBalance">0</div>
                    </div>
                    <div class="stat-card storage">
                        <div class="stat-label">Records</div>
                        <div class="stat-value storage" id="totalRecords">0</div>
                    </div>
                </div>
            </section>

            <!-- Transactions Section -->
            <section class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-list"></i> Transactions
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-ghost" id="selectModeBtn" onclick="toggleSelectMode()">
                            <i class="fas fa-check-square"></i>
                        </button>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 0.5rem;">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç Search..." oninput="renderTransactions()">
                    <select id="filterType" class="form-control" onchange="renderTransactions()">
                        <option value="all">All</option>
                        <option value="credit">Income</option>
                        <option value="debit">Expense</option>
                    </select>
                </div>

                <div class="transaction-list" id="transactionList"></div>
            </section>
        </main>

        <!-- Batch Actions -->
        <div id="batchActions" class="batch-actions">
            <div class="batch-actions-content">
                <span><span class="batch-count" id="selectedCount">0</span> selected</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-danger" onclick="deleteSelected()">Delete</button>
                    <button class="btn btn-sm btn-secondary" onclick="cancelSelection()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title"><i class="fas fa-cog"></i> Settings</span>
                <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
            </div>
            
            <div class="info-box idb">
                <i class="fas fa-database"></i>
                <span>Using IndexedDB for local storage</span>
            </div>

            <div class="security-option" style="background: rgba(239, 68, 68, 0.1);">
                <div class="security-option-info">
                    <div class="security-option-title" style="color: var(--danger);">
                        <i class="fas fa-trash"></i> Clear All Data
                    </div>
                    <div class="security-option-desc">Delete all transactions and reset the app</div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="confirmClearAll()">Clear</button>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title"><i class="fas fa-edit"></i> Edit Transaction</span>
                <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
            </div>
            
            <input type="hidden" id="editId">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" id="editAmount" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select id="editType" class="form-control">
                        <option value="credit">Income</option>
                        <option value="debit">Expense</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Bank</label>
                    <select id="editBank" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date (BS)</label>
                    <input type="text" id="editDate" class="form-control" placeholder="YYYY/MM/DD">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" id="editAccount" class="form-control" placeholder="A/C No.">
                </div>
                <div class="form-group">
                    <label class="form-label">Remarks</label>
                    <input type="text" id="editRemarks" class="form-control">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveEdit()">
                    <i class="fas fa-save"></i> Save & Learn
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <span class="modal-title">‚ö†Ô∏è Confirm</span>
                <button class="modal-close" onclick="closeModal('confirmModal')">√ó</button>
            </div>
            <p id="confirmMessage"></p>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // INDEXEDDB DATABASE MANAGER
        // ============================================
        
        const DB_NAME = 'SMSParserDB';
        const DB_VERSION = 2; // Incremented to trigger object store creation
        
        const STORES = {
            TRANSACTIONS: 'transactions',
            PATTERNS: 'patterns',
            CORRECTIONS: 'corrections',
            SECURITY: 'security',
            SETTINGS: 'settings'
        };

        class IndexedDBManager {
            constructor() {
                this.db = null;
                this.isReady = false;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = () => {
                        console.error('IndexedDB error:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        this.isReady = true;
                        console.log('IndexedDB initialized successfully');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Transactions store
                        if (!db.objectStoreNames.contains(STORES.TRANSACTIONS)) {
                            const txnStore = db.createObjectStore(STORES.TRANSACTIONS, { keyPath: 'id' });
                            txnStore.createIndex('type', 'type', { unique: false });
                            txnStore.createIndex('bank', 'bank', { unique: false });
                            txnStore.createIndex('date', 'date', { unique: false });
                            txnStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }

                        // Patterns store
                        if (!db.objectStoreNames.contains(STORES.PATTERNS)) {
                            const patternStore = db.createObjectStore(STORES.PATTERNS, { keyPath: 'id' });
                            patternStore.createIndex('name', 'name', { unique: false });
                        }

                        // Corrections store
                        if (!db.objectStoreNames.contains(STORES.CORRECTIONS)) {
                            const corrStore = db.createObjectStore(STORES.CORRECTIONS, { keyPath: 'id' });
                            corrStore.createIndex('usageCount', 'usageCount', { unique: false });
                        }

                        // Security store (for PIN hash, salt, etc.)
                        if (!db.objectStoreNames.contains(STORES.SECURITY)) {
                            db.createObjectStore(STORES.SECURITY, { keyPath: 'key' });
                        }

                        // Settings store
                        if (!db.objectStoreNames.contains(STORES.SETTINGS)) {
                            db.createObjectStore(STORES.SETTINGS, { keyPath: 'key' });
                        }

                        console.log('IndexedDB stores created');
                    };
                });
            }

            // Generic CRUD operations
            async add(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Database not initialized'));
                        return;
                    }
                    
                    // Check if store exists
                    if (!this.db.objectStoreNames.contains(storeName)) {
                        console.error(`Object store '${storeName}' not found. Available stores:`, Array.from(this.db.objectStoreNames));
                        reject(new Error(`Object store '${storeName}' not found`));
                        return;
                    }
                    
                    try {
                        const transaction = this.db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => {
                            console.error(`Error getting all from ${storeName}:`, request.error);
                            reject(request.error);
                        };
                    } catch (error) {
                        console.error(`Transaction error for ${storeName}:`, error);
                        reject(error);
                    }
                });
            }

            async delete(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            async count(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.count();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteDatabase() {
                return new Promise((resolve, reject) => {
                    if (this.db) {
                        this.db.close();
                    }
                    
                    const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                    
                    deleteRequest.onsuccess = () => {
                        console.log('Database deleted successfully');
                        this.db = null;
                        this.isReady = false;
                        resolve();
                    };
                    
                    deleteRequest.onerror = () => {
                        console.error('Error deleting database:', deleteRequest.error);
                        reject(deleteRequest.error);
                    };
                    
                    deleteRequest.onblocked = () => {
                        console.warn('Database deletion blocked');
                    };
                });
            }

            async clearAll() {
                const promises = Object.values(STORES).map(store => this.clear(store));
                return Promise.all(promises);
            }

            async estimateSize() {
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    return {
                        usage: estimate.usage || 0,
                        quota: estimate.quota || 0
                    };
                }
                return { usage: 0, quota: 0 };
            }
        }

        const DB = new IndexedDBManager();

        // ============================================
        // STATE
        // ============================================
        
        const BANKS = [
            { id: 'sanima', name: 'Sanima Bank', keywords: ['sanima', 'sbl'] },
            { id: 'global', name: 'Global IME', keywords: ['global', 'gibl'] },
            { id: 'nabil', name: 'Nabil Bank', keywords: ['nabil', 'nabilbank'] },
            { id: 'nic', name: 'NIC Asia', keywords: ['nic', 'nicasia', 'nicasiabank'] },
            { id: 'everest', name: 'Everest Bank', keywords: ['everest', 'ebl'] },
            { id: 'himalayan', name: 'Himalayan Bank', keywords: ['himalayan', 'hbl'] },
            { id: 'nmb', name: 'NMB Bank', keywords: ['nmb', 'nmbbank'] },
            { id: 'prabhu', name: 'Prabhu Bank', keywords: ['prabhu', 'pbl'] },
            { id: 'kumari', name: 'Kumari Bank', keywords: ['kumari', 'kbl'] },
            { id: 'agriculture', name: 'Agriculture Development Bank', keywords: ['adbl', 'agriculture', 'krishi'] },
            { id: 'rastriya', name: 'Rastriya Banijya Bank', keywords: ['rbb', 'rastriya', 'banijya'] },
            { id: 'siddhartha', name: 'Siddhartha Bank', keywords: ['siddhartha', 'sbl'] },
            { id: 'citizen', name: 'Citizen Bank', keywords: ['citizen', 'citz'] },
            { id: 'laxmi', name: 'Laxmi Bank', keywords: ['laxmi', 'lbl'] },
            { id: 'machhapuchhre', name: 'Machhapuchhre Bank', keywords: ['machhapuchhre', 'mbl'] },
            { id: 'janata', name: 'Janata Bank', keywords: ['janata', 'jbl'] },
            { id: 'nepal', name: 'Nepal Bank', keywords: ['nepal', 'nbl'] },
            { id: 'prime', name: 'Prime Bank', keywords: ['prime', 'pbl'] },
            { id: 'sahara', name: 'Sahara Bank', keywords: ['sahara', 'shbl'] },
            { id: 'sunrise', name: 'Sunrise Bank', keywords: ['sunrise', 'srbl'] },
            { id: 'civil', name: 'Civil Bank', keywords: ['civil', 'cbl'] },
            { id: 'garima', name: 'Garima Bank', keywords: ['garima', 'gbl'] },
            { id: 'jyoti', name: 'Jyoti Bank', keywords: ['jyoti', 'jbl'] },
            { id: 'kantipur', name: 'Kantipur Bank', keywords: ['kantipur', 'kbl'] },
            { id: 'mahalaxmi', name: 'Mahalaxmi Bank', keywords: ['mahalaxmi', 'mlbl'] },
            { id: 'miteri', name: 'Miteri Bank', keywords: ['miteri', 'mbl'] },
            { id: 'sambandha', name: 'Sambandha Bank', keywords: ['sambandha', 'sbl'] },
            { id: 'shangrila', name: 'Shangrila Bank', keywords: ['shangrila', 'sbl'] },
            { id: 'singh', name: 'Singh Development Bank', keywords: ['singh', 'sdbl'] },
            { id: 'value', name: 'Value Bank', keywords: ['value', 'vbl'] },
            { id: 'ccbl', name: 'Clean Energy Development Bank', keywords: ['ccbl', 'clean'] },
            { id: 'dibl', name: 'Deva Development Bank', keywords: ['dibl', 'deva'] },
            { id: 'jbb', name: 'Jebhils Bank', keywords: ['jbb', 'jebhils'] },
            { id: 'lib', name: 'Lumbini Bank', keywords: ['lib', 'lumbini'] },
            { id: 'pbb', name: 'Patanjali Bank', keywords: ['pbb', 'patanjali'] },
            { id: 'sbl', name: 'Saptakoshi Bank', keywords: ['sbl', 'saptakoshi'] },
            { id: 'tbb', name: 'Tilottama Bank', keywords: ['tbb', 'tilottama'] },
            { id: 'ybl', name: 'Yogi Bank', keywords: ['ybl', 'yogi'] },
            { id: 'esewa', name: 'eSewa', keywords: ['esewa', 'esewa.com'] },
            { id: 'khalti', name: 'Khalti', keywords: ['khalti', 'khalti.com'] },
            { id: 'imepay', name: 'IME Pay', keywords: ['imepay', 'ime', 'imepay.com'] },
            { id: 'prabhu-pay', name: 'Prabhu Pay', keywords: ['prabhupay', 'prabhu pay'] },
            { id: 'connectips', name: 'Connect IPS', keywords: ['connectips', 'connect'] },
            { id: 'cellpay', name: 'CellPay', keywords: ['cellpay', 'cell'] }
        ];

        const CREDIT_KW = [
            'credited', 'deposited', 'received', 'credit', 'added', 'cr', 'inward', 'refund', 
            'cashback', 'bonus', 'reward', 'salary', 'income', 'transfer in', 'received from'
        ];
        const DEBIT_KW = [
            'debited', 'withdrawn', 'debit', 'paid', 'dr', 'deducted', 'charged', 'expense',
            'purchase', 'payment', 'sent', 'transfer out', 'billed', 'outward', 'spent'
        ];

        let state = {
            unlocked: true,
            transactions: [],
            patterns: [],
            corrections: [],
            selectMode: false,
            selected: new Set(),
            training: {
                active: false,
                field: null,
                marks: {}
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', init);

        // Database reset function for troubleshooting
        async function resetDatabase() {
            try {
                console.log('Resetting database...');
                await DB.deleteDatabase();
                console.log('Database reset complete');
                location.reload();
            } catch (error) {
                console.error('Error resetting database:', error);
            }
        }

        async function init() {
            try {
                updateLoadingText('Initializing IndexedDB...');
                await DB.init();
                
                updateLoadingText('Loading data...');
                
                // Try to load data with fallback
                try {
                    state.transactions = await DB.getAll(STORES.TRANSACTIONS);
                    state.patterns = await DB.getAll(STORES.PATTERNS);
                    state.corrections = await DB.getAll(STORES.CORRECTIONS);
                } catch (dbError) {
                    console.warn('Database loading error, using fallback:', dbError);
                    // Fallback to empty arrays if database fails
                    state.transactions = [];
                    state.patterns = [];
                    state.corrections = [];
                }
                
                // Sort transactions by date descending
                state.transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                hideLoading();
                
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('visible');
                state.unlocked = true;
                
                populateBankSelects();
                setDefaultDate();
                updateUI();
                renderTable();
                updateStorageInfo();
                
            } catch (error) {
                console.error('Initialization error:', error);
                updateLoadingText('Error: ' + error.message);
                
                // Add retry and reset buttons
                setTimeout(() => {
                    updateLoadingText('Error: ' + error.message + 
                        ' <button onclick="location.reload()">Retry</button>' +
                        ' <button onclick="resetDatabase()">Reset Database</button>');
                }, 2000);
            }
        }

        function updateLoadingText(text) {
            document.querySelector('.loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function populateBankSelects() {
            const banks = BANKS.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
            document.getElementById('manualBank').innerHTML = '<option value="">Select Bank</option>' + banks;
            document.getElementById('editBank').innerHTML = '<option value="">Select Bank</option>' + banks;
        }

        function setDefaultDate() {
            const today = getCurrentNepaliDate();
            const todayBs = formatBsDate(today.year, today.month, today.day);
            document.getElementById('manualDate').value = todayBs;
            document.getElementById('editDate').value = todayBs;
        }

        // ============================================
        // TRANSACTION CRUD WITH INDEXEDDB
        // ============================================
        
        async function addTransaction(data) {
            const txn = {
                id: genId(),
                amount: data.amount,
                type: data.type,
                bank: data.bank,
                date_bs: data.date, // Store BS date directly
                account: data.account,
                remarks: data.remarks,
                rawSMS: data.rawSMS || '',
                category: data.category || 'general',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            await DB.add(STORES.TRANSACTIONS, txn);
            state.transactions.unshift(txn);
            
            // Auto-update tracker with parsed transaction
            await updateTrackerWithTransaction(txn);
            
            updateUI();
            renderTable();
            updateStorageInfo();
            return txn;
        }

        async function updateTransaction(id, updates) {
            const idx = state.transactions.findIndex(t => t.id === id);
            if (idx === -1) return null;
            
            const original = { ...state.transactions[idx] };
            const updated = { 
                ...original, 
                ...updates, 
                updatedAt: new Date().toISOString() 
            };
            
            await DB.put(STORES.TRANSACTIONS, updated);
            state.transactions[idx] = updated;
            
            return { original, updated };
        }

        async function deleteTransaction(id) {
            await DB.delete(STORES.TRANSACTIONS, id);
            state.transactions = state.transactions.filter(t => t.id !== id);
            updateUI();
            renderTable();
            updateStorageInfo();
        }

        async function deleteMultipleTransactions(ids) {
            for (const id of ids) {
                await DB.delete(STORES.TRANSACTIONS, id);
            }
            state.transactions = state.transactions.filter(t => !ids.has(t.id));
            updateUI();
            renderTable();
            updateStorageInfo();
        }

        // ============================================
        // PATTERNS & CORRECTIONS (IndexedDB)
        // ============================================
        
        async function savePatternToDB(pattern) {
            // Validate pattern before saving
            const validation = validatePattern(pattern);
            if (!validation.valid) {
                showAlert(validation.message, 'warning');
                return;
            }
            
            await DB.put(STORES.PATTERNS, pattern);
            const idx = state.patterns.findIndex(p => p.id === pattern.id);
            if (idx !== -1) {
                state.patterns[idx] = pattern;
            } else {
                state.patterns.push(pattern);
            }
            updateStorageInfo();
            
            // Provide feedback on what was learned
            const learnedFields = [];
            if (pattern.credit && pattern.credit.length > 0) learnedFields.push(`${pattern.credit.length} credit keywords`);
            if (pattern.debit && pattern.debit.length > 0) learnedFields.push(`${pattern.debit.length} debit keywords`);
            if (pattern.bank && pattern.bank.length > 0) learnedFields.push(`${pattern.bank.length} bank keywords`);
            if (pattern.date && pattern.date.length > 0) learnedFields.push(`${pattern.date.length} date keywords`);
            if (pattern.remarks && pattern.remarks.length > 0) learnedFields.push(`${pattern.remarks.length} remarks keywords`);
            if (pattern.account && pattern.account.length > 0) learnedFields.push(`${pattern.account.length} account keywords`);
            
            showAlert(`Pattern saved! Learned: ${learnedFields.join(', ')}`, 'success');
        }
        
        function validatePattern(pattern) {
            const totalKeywords = 
                (pattern.credit?.length || 0) + 
                (pattern.debit?.length || 0) + 
                (pattern.bank?.length || 0) + 
                (pattern.date?.length || 0) + 
                (pattern.remarks?.length || 0) + 
                (pattern.account?.length || 0);
            
            if (totalKeywords === 0) {
                return { valid: false, message: 'Please select at least one word to train' };
            }
            
            if (!pattern.name || pattern.name.trim().length < 3) {
                return { valid: false, message: 'Pattern name must be at least 3 characters' };
            }
            
            if (totalKeywords < 2) {
                return { valid: false, message: 'Please select at least 2 keywords for better learning' };
            }
            
            return { valid: true };
        }

        async function saveCorrectionToDB(correction) {
            await DB.put(STORES.CORRECTIONS, correction);
            const idx = state.corrections.findIndex(c => c.id === correction.id);
            if (idx !== -1) {
                state.corrections[idx] = correction;
            } else {
                state.corrections.push(correction);
            }
        }

        async function learnFromEdit(original, updated) {
            if (!original.rawSMS) return;
            
            const changes = {};
            if (original.type !== updated.type) changes.type = updated.type;
            if (original.bank !== updated.bank) changes.bank = updated.bank;
            
            if (Object.keys(changes).length === 0) return;
            
            const keywords = original.rawSMS.toLowerCase()
                .split(/[\s,.:;!?()]+/)
                .filter(w => w.length > 3 && !/^\d+$/.test(w))
                .slice(0, 3);
            
            if (keywords.length === 0) return;
            
            let correction = state.corrections.find(c => 
                c.keywords?.some(k => keywords.includes(k))
            );
            
            if (!correction) {
                correction = {
                    id: genId(),
                    keywords: keywords,
                    typeKeywords: { credit: [], debit: [] },
                    bankKeywords: [],
                    bank: null,
                    createdAt: new Date().toISOString(),
                    usageCount: 0
                };
            }
            
            if (changes.type) {
                const typeKw = original.rawSMS.toLowerCase()
                    .split(/\s+/)
                    .find(w => CREDIT_KW.includes(w) || DEBIT_KW.includes(w)) || keywords[0];
                
                if (changes.type === 'credit') {
                    correction.typeKeywords.credit = [...new Set([...correction.typeKeywords.credit, typeKw])];
                } else {
                    correction.typeKeywords.debit = [...new Set([...correction.typeKeywords.debit, typeKw])];
                }
            }
            
            if (changes.bank) {
                correction.bank = changes.bank;
                correction.bankKeywords = [...new Set([...correction.bankKeywords, ...keywords.slice(0, 1)])];
            }
            
            correction.usageCount++;
            correction.updatedAt = new Date().toISOString();
            
            await saveCorrectionToDB(correction);
            showAlert('üß† Learned from your edit!', 'info');
        }

        // ============================================
        // TRACKER INTEGRATION
        // ============================================
        
        async function updateTrackerWithTransaction(transaction) {
            try {
                // Map bank transaction to tracker category
                const category = mapBankTransactionToCategory(transaction);
                
                // Convert transaction date to BS date format (simplified)
                const bsDate = convertToBSDate(transaction.date);
                
                // Create tracker transaction data
                const trackerData = {
                    date_bs: bsDate,
                    category: category,
                    currency: 'NPR',
                    amount: transaction.amount,
                    description: `${transaction.bank}: ${transaction.remarks || 'Bank Transaction'}`,
                    source: 'sms_parser',
                    sourceId: transaction.id,
                    bank: transaction.bank,
                    account: transaction.account,
                    createdAt: new Date().toISOString()
                };
                
                // Store in localStorage for the main app to pick up
                const pendingTransactions = JSON.parse(localStorage.getItem('pendingTrackerTransactions') || '[]');
                pendingTransactions.push(trackerData);
                localStorage.setItem('pendingTrackerTransactions', JSON.stringify(pendingTransactions));
                
                // Show notification to user
                showAlert(`üìä Transaction added to tracker: ${transaction.type === 'credit' ? 'Income' : 'Expense'} - Rs. ${transaction.amount.toLocaleString()}`, 'success');
                
            } catch (error) {
                console.error('Error updating tracker:', error);
                // Don't show error to user as SMS parser should work independently
            }
        }
        
        function mapBankTransactionToCategory(transaction) {
            const remarks = String(transaction.remarks || '').toLowerCase();
            const bank = String(transaction.bank || '').toLowerCase();
            
            // Income categories
            if (transaction.type === 'credit') {
                if (remarks.includes('salary') || remarks.includes('payroll')) return 'Salary';
                if (remarks.includes('bonus') || remarks.includes('reward')) return 'Other';
                if (remarks.includes('refund') || remarks.includes('return')) return 'Other';
                if (remarks.includes('transfer') || remarks.includes('received')) return 'Business';
                if (bank.includes('esewa') || bank.includes('khalti')) return 'Business';
                return 'Other';
            }
            
            // Expense categories
            if (transaction.type === 'debit') {
                // Food & Dining
                if (remarks.includes('restaurant') || remarks.includes('food') || remarks.includes('meal') || 
                    remarks.includes('coffee') || remarks.includes('bhatbhateni') || remarks.includes('mart')) {
                    return 'Food';
                }
                
                // Transport
                if (remarks.includes('petrol') || remarks.includes('fuel') || remarks.includes('parking') || 
                    remarks.includes('taxi') || remarks.includes('uber') || remarks.includes('pathao') || 
                    remarks.includes('transport') || remarks.includes('travel')) {
                    return 'Transport';
                }
                
                // Shopping
                if (remarks.includes('shopping') || remarks.includes('purchase') || remarks.includes('retail') || 
                    remarks.includes('store') || remarks.includes('mall') || remarks.includes('daraz') || 
                    remarks.includes('sastodeal') || remarks.includes('hamro')) {
                    return 'Shopping';
                }
                
                // Bills & Utilities
                if (remarks.includes('bill') || remarks.includes('electricity') || remarks.includes('water') || 
                    remarks.includes('internet') || remarks.includes('phone') || remarks.includes('recharge') || 
                    remarks.includes('subscription')) {
                    return 'Bills';
                }
                
                // Healthcare
                if (remarks.includes('hospital') || remarks.includes('medical') || remarks.includes('pharmacy') || 
                    remarks.includes('health') || remarks.includes('medicine')) {
                    return 'Healthcare';
                }
                
                // Education
                if (remarks.includes('school') || remarks.includes('college') || remarks.includes('education') || 
                    remarks.includes('course') || remarks.includes('fee')) {
                    return 'Education';
                }
                
                // Entertainment
                if (remarks.includes('movie') || remarks.includes('cinema') || remarks.includes('game') || 
                    remarks.includes('entertainment') || remarks.includes('subscription')) {
                    return 'Entertainment';
                }
                
                // Default to Other for unrecognized expenses
                return 'Other';
            }
            
            return 'Other';
        }
        
        function convertToBSDate(isoDate) {
            try {
                const date = new Date(isoDate);
                
                // Check if adToBs function is available (from main app)
                if (typeof adToBs === 'function') {
                    const bsDate = adToBs(date.getFullYear(), date.getMonth() + 1, date.getDate());
                    return `${bsDate.year}/${String(bsDate.month).padStart(2, '0')}/${String(bsDate.day).padStart(2, '0')}`;
                } else {
                    // Fallback: Simple conversion - in real implementation, would use proper BS conversion library
                    // For now, just format as YYYY/MM/DD
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}/${month}/${day}`;
                }
            } catch (error) {
                // Fallback to today's date
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            }
        }

        // ============================================
        // SMS PARSING
        // ============================================
        
        function parseSMS(text) {
            if (!text?.trim()) return null;
            text = text.trim();
            
            let result = {
                amount: null,
                type: null,
                bank: 'Unknown',
                date: new Date(),
                remarks: null,
                rawSMS: text,
                confidence: 0,
                source: 'default'
            };
            
            // Normalize text for better parsing
            const normalizedText = text.replace(/\s+/g, ' ').trim();
            const lower = normalizedText.toLowerCase();
            
            // Apply learned corrections first (highest priority)
            for (const corr of state.corrections) {
                if (corr.keywords?.some(k => lower.includes(k))) {
                    result.source = 'learned';
                    result.confidence += 25;
                    
                    // Apply learned type keywords
                    for (const kw of (corr.typeKeywords?.credit || [])) {
                        if (lower.includes(kw)) { 
                            result.type = 'credit'; 
                            result.confidence += 20; 
                            break; 
                        }
                    }
                    for (const kw of (corr.typeKeywords?.debit || [])) {
                        if (lower.includes(kw)) { 
                            result.type = 'debit'; 
                            result.confidence += 20; 
                            break; 
                        }
                    }
                    
                    // Apply learned bank
                    if (corr.bank) {
                        result.bank = corr.bank;
                        result.confidence += 15;
                    }
                    break;
                }
            }
            
            // Apply custom patterns (medium priority)
            for (const pat of state.patterns) {
                let patternMatched = false;
                
                // Check credit patterns
                for (const kw of (pat.credit || [])) {
                    if (lower.includes(kw) && !result.type) { 
                        result.type = 'credit'; 
                        result.confidence += 15;
                        result.source = 'pattern';
                        patternMatched = true;
                    }
                }
                
                // Check debit patterns
                for (const kw of (pat.debit || [])) {
                    if (lower.includes(kw) && !result.type) { 
                        result.type = 'debit'; 
                        result.confidence += 15;
                        result.source = 'pattern';
                        patternMatched = true;
                    }
                }
                
                // Check date patterns
                if (pat.date && pat.date.length > 0) {
                    const dateWords = pat.date.join('|');
                    const dateMatch = normalizedText.match(new RegExp(`\\b(${dateWords})\\b[^\\s]*\\s*(\\d{1,4})[\\/\\-\\.]\\s*(\\d{1,2})[\\/\\-\\.]\\s*(\\d{2,4})\\b`, 'i'));
                    if (dateMatch) {
                        const dateStr = dateMatch[0];
                        const extractedDate = extractDate(dateStr);
                        if (extractedDate && extractedDate.getFullYear() > 2000) {
                            result.date = extractedDate;
                            result.confidence += 10;
                            patternMatched = true;
                        }
                    }
                }
                
                // Check remarks patterns
                if (pat.remarks && pat.remarks.length > 0) {
                    const remarksWords = pat.remarks.join('|');
                    const remarksMatch = normalizedText.match(new RegExp(`\\b(${remarksWords})\\b[^\\s]*\\s*([A-Za-z0-9\\s&\\-\\.\\,]{3,40})`, 'i'));
                    if (remarksMatch && !result.remarks) {
                        const remark = remarksMatch[0].trim().substring(0, 50);
                        if (remark.length > 3) {
                            result.remarks = remark;
                            result.confidence += 8;
                            patternMatched = true;
                        }
                    }
                }
                
                // Check account patterns
                if (pat.account && pat.account.length > 0) {
                    const accountWords = pat.account.join('|');
                    const accountMatch = normalizedText.match(new RegExp(`\\b(${accountWords})\\b[^\\s]*\\s*([A-Za-z0-9]{6,20})`, 'i'));
                    if (accountMatch && !result.account) {
                        const account = accountMatch[0].trim().substring(0, 20);
                        if (account.length >= 6 && /\d/.test(account)) {
                            result.account = account;
                            result.confidence += 8;
                            patternMatched = true;
                        }
                    }
                }
                
                // Apply pattern-specific bank if available
                if (patternMatched && pat.bank) {
                    result.bank = pat.bank;
                    result.confidence += 10;
                }
            }
            
            // Default parsing with enhanced patterns
            if (!result.amount) {
                result.amount = extractAmount(normalizedText);
            }
            if (!result.type) {
                result.type = extractType(normalizedText);
            }
            if (result.bank === 'Unknown') {
                result.bank = extractBank(normalizedText);
            }
            result.date = extractDate(normalizedText);
            result.remarks = extractRemarks(normalizedText);
            result.account = extractAccount(normalizedText);
            
            // Enhanced confidence scoring
            if (result.amount && result.amount > 0) {
                result.confidence += 35;
                
                // Bonus for realistic amounts
                if (result.amount >= 10 && result.amount <= 1000000) {
                    result.confidence += 5;
                }
            }
            
            if (result.type) {
                result.confidence += 25;
                
                // Bonus for clear type indicators
                const clearIndicators = ['credited', 'debited', 'deposited', 'withdrawn'];
                if (clearIndicators.some(ind => lower.includes(ind))) {
                    result.confidence += 10;
                }
            }
            
            if (result.bank !== 'Unknown') {
                result.confidence += 15;
                
                // Bonus for well-known banks
                const majorBanks = ['nabil', 'global', 'nic', 'sanima', 'himalayan', 'esewa', 'khalti'];
                if (majorBanks.some(bank => lower.includes(bank))) {
                    result.confidence += 5;
                }
            }
            
            if (result.remarks && result.remarks.length > 5) {
                result.confidence += 10;
            }
            
            if (result.account && result.account.length > 5) {
                result.confidence += 8;
            }
            
            // Cap confidence at 100
            result.confidence = Math.min(result.confidence, 100);
            
            // Ensure minimum confidence for valid transactions
            if (result.amount && result.type && result.confidence < 30) {
                result.confidence = 30;
            }
            
            return result;
        }

        function extractAmount(text) {
            const patterns = [
                // Standard NPR patterns
                /(?:NPR|Rs\.?|NRs\.?)\s*([\d,]+(?:\.\d{1,2})?)/i,
                // Amount before transaction type
                /([\d,]+(?:\.\d{2})?)\s*(?:deposited|credited|debited|withdrawn|transferred|sent|received)/i,
                // Amount with "by" or "of"
                /(?:by|of|for)\s*(?:NPR|Rs\.?|NRs\.?)?\s*([\d,]+(?:\.\d{1,2})?)/i,
                // Amount in brackets
                /\[?\(?\s*(?:NPR|Rs\.?|NRs\.?)?\s*([\d,]+(?:\.\d{1,2})?)\s*\]?\)?/i,
                // Amount after transaction details
                /(?:amount|balance|available)\s*(?:is)?\s*(?:NPR|Rs\.?|NRs\.?)?\s*([\d,]+(?:\.\d{1,2})?)/i,
                // Simple number patterns (fallback)
                /(?:^|\s)([\d,]{1,8}(?:\.\d{1,2})?)(?:\s|$)/,
                // Amount with currency code at end
                /([\d,]+(?:\.\d{1,2})?)\s*(?:NPR|Rs|NRs)/i
            ];
            
            for (const p of patterns) {
                const m = text.match(p);
                if (m) {
                    const amt = parseFloat(m[1].replace(/,/g, ''));
                    if (amt > 0 && amt < 1e8) return amt;
                }
            }
            return null;
        }

        function extractType(text) {
            const lower = text.toLowerCase();
            for (const kw of CREDIT_KW) if (lower.includes(kw)) return 'credit';
            for (const kw of DEBIT_KW) if (lower.includes(kw)) return 'debit';
            return null;
        }

        function extractBank(text) {
            const lower = text.toLowerCase();
            for (const bank of BANKS) {
                for (const kw of bank.keywords) {
                    if (lower.includes(kw)) return bank.name;
                }
            }
            return 'Unknown';
        }

        function extractDate(text) {
            // Standard English date patterns - order matters!
            const patterns = [
                // ISO date format YYYY-MM-DD (most specific first)
                /(\d{4})-(\d{2})-(\d{2})/,
                // YYYY/MM/DD, YYYY-MM-DD (with time)
                /(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/,
                // DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY  
                /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/,
                // Month name patterns
                /(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{2,4})/i,
                // Day Month Year
                /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{1,2})[,\s]+\s*(\d{2,4})/i,
                // Date with "on" preposition - common in bank SMS
                /(?:on|dated)\s+(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/i,
                // Date after transaction type
                /(?:credited|debited|deposited|withdrawn|transferred|sent|received)\s+(?:on|dated)?\s+(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/i,
                // Date in brackets
                /\[?\(?(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})\]?\)?/i
            ];
            
            for (const p of patterns) {
                const m = text.match(p);
                if (m) {
                    let d, mo, y;
                    
                    if (p === patterns[0]) {
                        // ISO format YYYY-MM-DD
                        y = +m[1]; mo = +m[2]; d = +m[3];
                    } else if (p === patterns[1]) {
                        // YYYY/MM/DD or YYYY-MM-DD (non-ISO)
                        y = +m[1]; mo = +m[2]; d = +m[3];
                    } else if (p === patterns[2]) {
                        // DD/MM/YYYY format
                        d = +m[1]; mo = +m[2]; y = +m[3];
                    } else if (p === patterns[3]) {
                        // Day Month Year
                        d = +m[1]; mo = new Date(Date.parse(m[2] + " 1, 2000")).getMonth() + 1; y = +m[3];
                    } else if (p === patterns[4]) {
                        // Month Day Year
                        mo = new Date(Date.parse(m[1] + " 1, 2000")).getMonth() + 1; d = +m[2]; y = +m[3];
                    } else if (p === patterns[5] || p === patterns[6] || p === patterns[7]) {
                        // Other numeric formats
                        d = +m[1]; mo = +m[2]; y = +m[3];
                    }
                    
                    if (y < 100) y += 2000;
                    if (y < 1900) y += 100;
                    
                    // Validate month and day
                    if (mo < 1 || mo > 12 || d < 1 || d > 31) continue;
                    
                    const date = new Date(y, mo - 1, d);
                    if (!isNaN(date.getTime()) && date.getFullYear() === y) {
                        return date;
                    }
                }
            }
            
            // Try to extract today's date keywords
            const todayKeywords = ['today'];
            const yesterdayKeywords = ['yesterday'];
            
            const lower = text.toLowerCase();
            if (todayKeywords.some(kw => lower.includes(kw))) {
                return new Date();
            }
            if (yesterdayKeywords.some(kw => lower.includes(kw))) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return yesterday;
            }
            
            // Default to current date
            return new Date();
        }

        function extractAccount(text) {
            const patterns = [
                // Account number patterns
                /(?:A\/C|Account|a\/c)\s*(?:no\.?|number|#)?\s*([A-Za-z0-9]{6,20})/i,
                // Account with XXXX masking
                /(?:A\/C|Account|a\/c)\s*(?:no\.?|number|#)?\s*(?:XXXX)?\d{4,8}\s*\*?\s*(\d{4,8})/i,
                // Simple account patterns
                /(?:A\/C|Account|a\/c)\s*[:\-]?\s*([A-Za-z0-9]{6,20})/i,
                // Account in brackets
                /\[?\(?([A-Za-z0-9]{6,20})\]?\)?\s*(?:A\/C|Account|a\/c)/i,
                // Common bank account patterns
                /(?:Account|A\/C|a\/c)\s*(?:no\.?|number|#)?\s*([0-9]{10,16})/,
                // Mobile wallet account patterns
                /(?:wallet|account|a\/c)\s*(?:no\.?|number|#)?\s*([0-9]{8,12})/,
                // Card number patterns (16 digits)
                /\b(?:\d{4}[\s\-]?\d{4}[\s\-]?\d{4}[\s\-]?\d{4})\b/
            ];
            
            for (const p of patterns) {
                const m = text.match(p);
                if (m) {
                    let account = m[1] || m[0];
                    
                    // Clean up the account number
                    account = account.replace(/[^\w\d]/g, '').trim();
                    
                    // Remove common prefixes/suffixes
                    account = account.replace(/^(A\/C|Account|a\/c|no|number|#)/i, '').trim();
                    account = account.replace(/(A\/C|Account|a\/c)$/i, '').trim();
                    
                    // Validate account number length
                    if (account.length >= 6 && account.length <= 20 && /\d/.test(account)) {
                        return account;
                    }
                }
            }
            
            return null;
        }

        function extractRemarks(text) {
            const patterns = [
                // Standard reference patterns
                /(?:Re:|Ref:|by:|for:|to:|from:|at:)\s*(.+?)(?:\.|$)/i,
                // Transaction details patterns
                /(?:transaction|payment|transfer|deposit|withdrawal)\s*(?:details?|info)?\s*(?:is|:)?\s*(.+?)(?:\.|$)/i,
                // Merchant/store patterns
                /(?:at|from|to|in)\s*([A-Z][a-zA-Z0-9\s&-]+?)(?:\s+(?:on|via|using)|\.|$)/i,
                // Description patterns
                /(?:description|remark|note|details?)\s*(?:is|:)?\s*(.+?)(?:\.|$)/i,
                // Between names pattern
                /(?:between|from)\s*([A-Za-z\s]+)\s*(?:and|to)\s*([A-Za-z\s]+)/i,
                // Account patterns
                /(?:account|a\/c)\s*(?:no\.?|number)?\s*(?:XXXX)?\d*\s*(?:to|from)?\s*(.+?)(?:\.|$)/i,
                // Mobile wallet patterns
                /(?:from|to)\s*(\d{10})\s*(?:on|via|using)?\s*(.+?)(?:\.|$)/i,
                // Generic description after amount
                /(?:Rs\.?|NPR)\s*[\d,]+\s*(?:has been)?\s*(?:credited|debited|transferred)\s*(?:to|from)?\s*(.+?)(?:\.|$)/i,
                // Last resort - capture meaningful text after transaction type
                /(?:credited|debited|deposited|withdrawn|transferred|sent|received)\s*(?:to|from)?\s*(.+?)(?:\.|$)/i,
                // Nepali bank specific patterns
                /(?:at|from)\s*([A-Z][a-zA-Z0-9\s&\-\.\,]+?)(?:\s+(?:on|via|using)|\.|$)/i,
                /(?:merchant|store|shop|retail|outlet|supermarket|mall)\s*[:\-]?\s*([A-Za-z0-9\s&\-\.\,]{3,40})/i,
                // Payment to patterns
                /(?:payment|paid|bill|invoice)\s*(?:to|for|at)?\s*([A-Za-z0-9\s&\-\.\,]{3,40})/i,
                // Location patterns
                /(?:location|loc|place)\s*[:\-]?\s*([A-Za-z0-9\s&\-\.\,]{3,30})/i
            ];
            
            for (const p of patterns) {
                const m = text.match(p);
                if (m) {
                    let remark = m[1] || m[0];
                    remark = remark.trim()
                        .replace(/\s+/g, ' ')
                        .replace(/[^\w\s\-\.\/@&\,\.\']/g, '')
                        .substring(0, 100);
                    
                    // Filter out common non-useful phrases
                    const excludePhrases = [
                        'your account', 'the account', 'has been', 'successfully', 
                        'transaction', 'payment', 'thank you', 'dear customer', 'bank',
                        'limited', 'ltd', 'pvt', 'private', 'company', 'corporation',
                        'nepal', 'kathmandu', 'lalitpur', 'bhaktapur', 'available balance',
                        'current balance', 'account balance', 'your a/c', 'a/c no'
                    ];
                    
                    const lowerRemark = remark.toLowerCase();
                    if (!excludePhrases.some(phrase => lowerRemark.includes(phrase)) && 
                        remark.length > 3 && 
                        !/^\d+$/.test(remark) &&
                        !/^(a\/c|account|balance|transaction|payment|bank|npr|rs\.?)/.test(lowerRemark)) {
                        return remark;
                    }
                }
            }
            
            // Try to extract merchant name from common patterns
            const merchantPatterns = [
                /(?:at|from)\s*([A-Z][a-zA-Z\s]{2,30}?)(?:\s+(?:on|via|using)|\.|$)/i,
                /(?:merchant|store|shop|retail|outlet|supermarket|mall|bazaar|market)\s*[:\-]?\s*([A-Za-z0-9\s&-]{3,30})/i,
                // Common Nepali merchant names
                /(Bhatbhateni|Big Mart|Saleways|Department Store|Foodmandu|Pathao|Daraz|Sastodeal|Hamro Bazaar|Mero Pasal|Online Khadya)/i
            ];
            
            for (const p of merchantPatterns) {
                const m = text.match(p);
                if (m) {
                    const merchant = (m[1] || m[0]).trim().substring(0, 50);
                    if (merchant.length > 3 && !/^\d+$/.test(merchant)) {
                        return merchant;
                    }
                }
            }
            
            return null;
        }

        // ============================================
        // UI HANDLERS
        // ============================================
        
        function switchTab(btn, tabId) {
            console.log('Switching to tab:', tabId); // Debug line
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Debug: Check if tab element exists and is visible
            const tabElement = document.getElementById(tabId);
            console.log('Tab element found:', !!tabElement);
            if (tabElement) {
                console.log('Tab classes:', tabElement.className);
                console.log('Tab display style:', window.getComputedStyle(tabElement).display);
                console.log('Tab visibility:', window.getComputedStyle(tabElement).visibility);
            }
            
            // If switching to table tab, render the table
            if (tabId === 'tab-table') {
                console.log('Rendering table...'); // Debug line
                renderTable();
            }
        }

        function previewSMS() {
            const text = document.getElementById('smsInput').value;
            const preview = document.getElementById('parsePreview');
            
            if (!text.trim()) {
                preview.classList.remove('show');
                return;
            }
            
            const parsed = parseSMS(text);
            if (!parsed?.amount) {
                preview.classList.remove('show');
                return;
            }
            
            preview.classList.add('show');
            preview.innerHTML = `
                <div class="parse-title"><i class="fas fa-search"></i> Detected ${parsed.source !== 'default' ? `<span style="color: var(--purple);">(${parsed.source})</span>` : ''}</div>
                <div class="parse-grid">
                    <div class="parse-item">
                        <div class="parse-label">Amount</div>
                        <div class="parse-value" style="color: ${parsed.type === 'credit' ? 'var(--success)' : 'var(--danger)'}">
                            Rs. ${parsed.amount?.toLocaleString() || '0'}
                        </div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Type</div>
                        <div class="parse-value">${parsed.type === 'credit' ? '‚¨áÔ∏è Income' : '‚¨ÜÔ∏è Expense'}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Bank</div>
                        <div class="parse-value">${parsed.bank}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Date</div>
                        <div class="parse-value" style="font-size: 0.75rem;">${formatDate(parsed.date)}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Account</div>
                        <div class="parse-value" style="font-size: 0.7rem; color: var(--accent);">${parsed.account || 'N/A'}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Remarks</div>
                        <div class="parse-value" style="font-size: 0.7rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${parsed.remarks || 'N/A'}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Confidence</div>
                        <div class="parse-value" style="color: ${parsed.confidence >= 60 ? 'var(--success)' : 'var(--warning)'}">${parsed.confidence}%</div>
                    </div>
                </div>
            `;
        }

        async function processSMS() {
            const text = document.getElementById('smsInput').value;
            if (!text.trim()) return showAlert('Enter SMS', 'error');
            
            const parsed = parseSMS(text);
            if (!parsed?.amount) return showAlert('Could not parse SMS', 'error');
            if (!parsed.type) parsed.type = 'debit';
            
            await addTransaction(parsed);
            document.getElementById('smsInput').value = '';
            document.getElementById('parsePreview').classList.remove('show');
            showAlert(`‚úì ${parsed.type === 'credit' ? 'Income' : 'Expense'}: Rs. ${parsed.amount.toLocaleString()}`, 'success');
        }

        async function processBulk() {
            const text = document.getElementById('bulkInput').value;
            if (!text.trim()) return showAlert('Enter SMS messages', 'error');
            
            const messages = text.split(/\n\s*\n/).filter(m => m.trim());
            let ok = 0, fail = 0;
            
            for (const msg of messages) {
                const parsed = parseSMS(msg.trim());
                if (parsed?.amount && parsed?.type) {
                    await addTransaction(parsed);
                    ok++;
                } else {
                    fail++;
                }
            }
            
            document.getElementById('bulkInput').value = '';
            showAlert(`${ok} added, ${fail} failed`, ok > 0 ? 'success' : 'warning');
        }

        async function addManual() {
            const amount = parseFloat(document.getElementById('manualAmount').value);
            const type = document.getElementById('manualType').value;
            const bank = document.getElementById('manualBank').value;
            const date = document.getElementById('manualDate').value;
            const account = document.getElementById('manualAccount').value;
            const remarks = document.getElementById('manualRemarks').value;
            
            if (!amount || amount <= 0) return showAlert('Enter valid amount', 'error');
            
            await addTransaction({
                amount, type, bank,
                date: date ? new Date(date) : new Date(),
                account, remarks
            });
            
            document.getElementById('manualAmount').value = '';
            document.getElementById('manualAccount').value = '';
            document.getElementById('manualRemarks').value = '';
            showAlert('Transaction added!', 'success');
        }

        function clearInput() {
            document.getElementById('smsInput').value = '';
            document.getElementById('parsePreview').classList.remove('show');
            cancelTraining();
        }

        // ============================================
        // TRAINING
        // ============================================
        
        function openTraining() {
            const text = document.getElementById('smsInput').value.trim();
            if (!text) return showAlert('Enter SMS first', 'error');
            
            state.training = {
                active: true,
                text: text,
                field: null,
                marks: { amount: [], credit: [], debit: [], bank: [], date: [], remarks: [], account: [] }
            };
            
            const words = text.split(/(\s+)/).filter(w => w.trim());
            document.getElementById('trainingSmsBox').innerHTML = words.map((w, i) =>
                `<span class="training-word" data-idx="${i}" data-word="${escapeHtml(w)}" onclick="markWord(${i})" style="display: inline-block; padding: 0.1rem 0.25rem; margin: 0.05rem; border-radius: 3px; cursor: pointer; border: 1px solid transparent;">${escapeHtml(w)}</span>`
            ).join(' ');
            
            document.getElementById('patternName').value = `${extractBank(text)} Pattern`;
            document.getElementById('trainingContainer').style.display = 'block';
        }

        function selectField(field, btn) {
            document.querySelectorAll('.field-btn').forEach(b => {
                b.style.background = 'white';
                b.style.color = 'var(--text-primary)';
            });
            btn.style.background = 'var(--accent)';
            btn.style.color = 'white';
            state.training.field = field;
        }

        function markWord(idx) {
            if (!state.training.field) return showAlert('Select field first', 'warning');
            
            const el = document.querySelector(`.training-word[data-idx="${idx}"]`);
            const word = el.dataset.word;
            const field = state.training.field;
            
            // Remove from all
            for (const f in state.training.marks) {
                const i = state.training.marks[f].findIndex(m => m.idx === idx);
                if (i !== -1) {
                    state.training.marks[f].splice(i, 1);
                    el.style.background = '';
                    el.style.borderColor = 'transparent';
                }
            }
            
            // Add to current
            state.training.marks[field].push({ idx, word });
            
            const colors = {
                amount: 'rgba(16, 185, 129, 0.25)',
                credit: 'rgba(16, 185, 129, 0.35)',
                debit: 'rgba(239, 68, 68, 0.35)',
                bank: 'rgba(99, 102, 241, 0.35)',
                date: 'rgba(245, 158, 11, 0.35)',
                remarks: 'rgba(139, 92, 246, 0.35)',
                account: 'rgba(34, 197, 94, 0.35)'
            };
            el.style.background = colors[field] || '';
            el.style.borderColor = 'var(--accent)';
        }

        async function savePattern() {
            const name = document.getElementById('patternName').value.trim() || 'Unnamed';
            const marks = state.training.marks;
            
            const pattern = {
                id: genId(),
                name,
                credit: marks.credit.map(m => m.word.toLowerCase()),
                debit: marks.debit.map(m => m.word.toLowerCase()),
                bank: marks.bank.map(m => m.word.toLowerCase()),
                date: marks.date.map(m => m.word.toLowerCase()),
                remarks: marks.remarks.map(m => m.word.toLowerCase()),
                account: marks.account.map(m => m.word.toLowerCase()),
                bankName: extractBank(state.training.text),
                example: state.training.text.substring(0, 80),
                createdAt: new Date().toISOString()
            };
            
            await savePatternToDB(pattern);
            cancelTraining();
            showAlert('Pattern saved!', 'success');
        }

        function cancelTraining() {
            state.training.active = false;
            document.getElementById('trainingContainer').style.display = 'none';
        }

        // ============================================
        // TRANSACTION LIST & SELECTION
        // ============================================
        
        function renderTransactions() {
            const list = document.getElementById('transactionList');
            const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const filter = document.getElementById('filterType')?.value || 'all';
            
            let filtered = state.transactions;
            if (filter !== 'all') filtered = filtered.filter(t => t.type === filter);
            if (search) filtered = filtered.filter(t => 
                (t.bank + (t.remarks || '') + (t.rawSMS || '')).toLowerCase().includes(search)
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No transactions</p></div>';
                return;
            }
            
            list.innerHTML = filtered.map(t => {
                const isSelected = state.selected.has(t.id);
                return `
                    <div class="transaction-item ${t.type === 'credit' ? 'income' : 'expense'} ${isSelected ? 'selected' : ''}" 
                         onclick="${state.selectMode ? `toggleSelect('${t.id}')` : `editTransaction('${t.id}')`}">
                        ${state.selectMode ? `
                            <input type="checkbox" class="transaction-checkbox" ${isSelected ? 'checked' : ''} 
                                   onclick="event.stopPropagation(); toggleSelect('${t.id}')">
                        ` : ''}
                        <div class="transaction-icon">
                            <i class="fas fa-${t.type === 'credit' ? 'arrow-down' : 'arrow-up'}"></i>
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-title">${t.remarks || t.bank}</div>
                            <div class="transaction-meta">
                                <span><i class="fas fa-university"></i> ${t.bank}</span>
                                <span><i class="fas fa-calendar"></i> ${formatDate(new Date(t.date))}</span>
                            </div>
                        </div>
                        <div class="transaction-right">
                            <div class="transaction-amount ${t.type === 'credit' ? 'income' : 'expense'}">
                                ${t.type === 'credit' ? '+' : '-'}Rs.${t.amount.toLocaleString()}
                            </div>
                            <div class="transaction-actions">
                                <button class="btn btn-ghost btn-icon" onclick="event.stopPropagation(); confirmDeleteSingle('${t.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSelectMode() {
            state.selectMode = !state.selectMode;
            state.selected.clear();
            updateBatchBar();
            renderTransactions();
            
            document.getElementById('selectModeBtn').style.color = state.selectMode ? 'var(--accent)' : '';
        }

        function toggleSelect(id) {
            if (state.selected.has(id)) {
                state.selected.delete(id);
            } else {
                state.selected.add(id);
            }
            updateBatchBar();
            renderTransactions();
        }

        function updateBatchBar() {
            const bar = document.getElementById('batchActions');
            const count = state.selected.size;
            document.getElementById('selectedCount').textContent = count;
            
            bar.classList.toggle('show', state.selectMode && count > 0);
        }

        async function deleteSelected() {
            if (state.selected.size === 0) return;
            
            showConfirm(`Delete ${state.selected.size} transactions?`, async () => {
                await deleteMultipleTransactions(state.selected);
                state.selected.clear();
                cancelSelection();
                showAlert('Deleted', 'success');
            });
        }

        function cancelSelection() {
            state.selectMode = false;
            state.selected.clear();
            updateBatchBar();
            renderTransactions();
            document.getElementById('selectModeBtn').style.color = '';
        }

        function confirmDeleteSingle(id) {
            showConfirm('Delete this transaction?', async () => {
                await deleteTransaction(id);
                showAlert('Deleted', 'success');
            });
        }

        // ============================================
        // EDIT TRANSACTION
        // ============================================
        
        function editTransaction(id) {
            const txn = state.transactions.find(t => t.id === id);
            if (!txn) return;
            
            // Store original for learning
            const original = { ...txn };
            
            document.getElementById('editId').value = id;
            document.getElementById('editAmount').value = txn.amount;
            document.getElementById('editType').value = txn.type;
            document.getElementById('editBank').value = txn.bank;
            document.getElementById('editDate').value = txn.date_bs || '';
            document.getElementById('editAccount').value = txn.account || '';
            document.getElementById('editRemarks').value = txn.remarks || '';
            
            // Store original for learning comparison
            window._editOriginal = original;
            
            openModal('editModal');
        }

        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const original = window._editOriginal;
            
            const updates = {
                amount: parseFloat(document.getElementById('editAmount').value),
                type: document.getElementById('editType').value,
                bank: document.getElementById('editBank').value,
                date_bs: document.getElementById('editDate').value,
                account: document.getElementById('editAccount').value || null,
                remarks: document.getElementById('editRemarks').value || null
            };
            
            // Check if there are meaningful changes
            const hasChanges = 
                original.amount !== updates.amount ||
                original.type !== updates.type ||
                original.bank !== updates.bank ||
                original.account !== updates.account ||
                original.remarks !== updates.remarks;
            
            if (!hasChanges) {
                closeModal('editModal');
                return;
            }
            
            // If changes detected, confirm learning
            const changes = [];
            if (original.type !== updates.type) changes.push(`Type: ${original.type} ‚Üí ${updates.type}`);
            if (original.bank !== updates.bank) changes.push(`Bank: ${original.bank} ‚Üí ${updates.bank}`);
            if (original.account !== updates.account) changes.push(`Account: ${original.account || 'N/A'} ‚Üí ${updates.account || 'N/A'}`);
            if (original.remarks !== updates.remarks) changes.push(`Remarks: ${original.remarks || 'N/A'} ‚Üí ${updates.remarks || 'N/A'}`);
            
            if (changes.length > 0) {
                showConfirm(`Learn from these changes?<br><br>${changes.join('<br>')}`, async () => {
                    const result = await updateTransaction(id, updates);
                    
                    if (result) {
                        await learnFromEdit(result.original, result.updated);
                        closeModal('editModal');
                        updateUI();
                        renderTable();
                        showAlert('‚úì Saved & Learned!', 'success');
                    }
                });
            } else {
                // Just save without learning if no meaningful changes
                const result = await updateTransaction(id, updates);
                if (result) {
                    closeModal('editModal');
                    updateUI();
                    renderTable();
                    showAlert('‚úì Saved!', 'success');
                }
            }
        }

        // ============================================
        // SETTINGS
        // ============================================
        
        function confirmClearAll() {
            showConfirm('Delete ALL data? This cannot be undone!', async () => {
                await DB.clearAll();
                closeModal('settingsModal');
                location.reload();
            });
        }

        function openSettings() {
            openModal('settingsModal');
        }

        // ============================================
        // UI UPDATES
        // ============================================
        
        function updateUI() {
            updateStats();
            renderTransactions();
        }

        function updateStats() {
            const income = state.transactions.filter(t => t.type === 'credit').reduce((s, t) => s + t.amount, 0);
            const expense = state.transactions.filter(t => t.type === 'debit').reduce((s, t) => s + t.amount, 0);
            const balance = income - expense;
            
            document.getElementById('totalIncome').textContent = `Rs.${income.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `Rs.${expense.toLocaleString()}`;
            document.getElementById('netBalance').textContent = `Rs.${balance.toLocaleString()}`;
            document.getElementById('netBalance').style.color = balance >= 0 ? 'var(--success)' : 'var(--danger)';
            document.getElementById('totalRecords').textContent = state.transactions.length;
        }

        async function updateStorageInfo() {
            const txnCount = await DB.count(STORES.TRANSACTIONS);
            const patCount = await DB.count(STORES.PATTERNS);
            const estimate = await DB.estimateSize();
            
            document.getElementById('dbTransactions').textContent = txnCount;
            document.getElementById('dbPatterns').textContent = patCount;
            document.getElementById('dbSize').textContent = formatBytes(estimate.usage);
        }

        // ============================================
        // UTILITIES
        // ============================================
        
        function populateBankSelects() {
            const opts = '<option value="Unknown">Unknown</option>' + 
                BANKS.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
            document.getElementById('manualBank').innerHTML = opts;
            document.getElementById('editBank').innerHTML = opts;
        }

        function setDefaultDate() {
            const today = getCurrentNepaliDate();
            const todayBs = formatBsDate(today.year, today.month, today.day);
            document.getElementById('manualDate').value = todayBs;
        }

        function genId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatDateFile(date) {
            return date.toISOString().split('T')[0];
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function download(content, filename) {
            const blob = new Blob([content], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        async function readClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text?.trim()) {
                    document.getElementById('smsInput').value = text.trim();
                    previewSMS();
                    showAlert('Pasted!', 'success');
                }
            } catch (e) {
                showAlert('Cannot access clipboard', 'error');
            }
        }

        function showAlert(msg, type = 'info') {
            const box = document.getElementById('alertBox');
            const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            box.querySelector('i').className = `fas fa-${icons[type]}`;
            document.getElementById('alertMessage').textContent = msg;
            box.className = `alert-box ${type} show`;
            setTimeout(() => box.classList.remove('show'), 3500);
        }

        function showConfirm(msg, onConfirm) {
            document.getElementById('confirmMessage').textContent = msg;
            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
                closeModal('confirmModal');
            };
            openModal('confirmModal');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function setupModalClicks() {
            document.querySelectorAll('.modal-overlay').forEach(m => {
                m.addEventListener('click', e => {
                    if (e.target === m) closeModal(m.id);
                });
            });
        }

        // ============================================
        // TEST FUNCTIONS
        // ============================================
        
        const TEST_EXAMPLES = {
            'nabil-credit': 'Dear Customer, NPR 5,000.00 has been credited to your A/C No. XXXX1234 on 15/01/2024. Available Balance: NPR 25,000.00. Nabil Bank',
            'nic-debit': 'Rs.1,200.00 debited from your NIC Asia Bank A/C XX7890 at Bhatbhateni Supermarket on 16-01-2024. Current Balance: Rs.15,750.00',
            'esewa-payment': 'You have successfully paid Rs.500.00 to Merchant: Daraz Nepal via eSewa on 17/01/2024. Transaction ID: ES123456789',
            'khalti-transfer': 'NPR 2,500.00 transferred from Khalti to 9841234567 on 18/01/2024. Remaining balance: NPR 8,500.00',
            'global-deposit': 'Global IME Bank: NPR 10,000.00 deposited to your account XXXX4567 on 19/01/2024 via Mobile Banking. Balance: NPR 45,000.00',
            'sanima-withdraw': 'Sanima Bank: Rs.3,000.00 withdrawn from ATM XYZ123 on 20/01/2024. Account Balance: Rs.22,000.00',
            'himalayan-transfer': 'NPR 7,500.00 has been transferred from your Himalayan Bank A/C XX3456 to A/C XX7890 on 21/01/2024. Balance: NPR 18,500.00',
            'nmb-purchase': 'NMB Bank: Rs.850.00 debited from your account XX5678 for online purchase at Mero Pasal on 22/01/2024. Available Balance: Rs.12,150.00'
        };
        
        function loadTestExample() {
            const select = document.getElementById('testExample');
            const textarea = document.getElementById('testSmsInput');
            
            if (select.value && TEST_EXAMPLES[select.value]) {
                textarea.value = TEST_EXAMPLES[select.value];
                testParseSMS();
            }
        }
        
        function testParseSMS() {
            const text = document.getElementById('testSmsInput').value;
            const preview = document.getElementById('testParsePreview');
            
            if (!text.trim()) {
                preview.classList.remove('show');
                return;
            }
            
            const parsed = parseSMS(text);
            if (!parsed?.amount) {
                preview.classList.remove('show');
                return;
            }
            
            preview.classList.add('show');
            preview.innerHTML = `
                <div class="parse-title"><i class="fas fa-search"></i> Test Result - ${parsed.source !== 'default' ? `<span style="color: var(--purple);">(${parsed.source})</span>` : ''}</div>
                <div class="parse-grid">
                    <div class="parse-item">
                        <div class="parse-label">Amount</div>
                        <div class="parse-value" style="color: ${parsed.type === 'credit' ? 'var(--success)' : 'var(--danger)'}">
                            Rs. ${parsed.amount?.toLocaleString() || '0'}
                        </div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Type</div>
                        <div class="parse-value">${parsed.type === 'credit' ? '‚¨áÔ∏è Income' : '‚¨ÜÔ∏è Expense'}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Bank</div>
                        <div class="parse-value">${parsed.bank}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Date</div>
                        <div class="parse-value">${formatDate(parsed.date)}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Account</div>
                        <div class="parse-value" style="font-size: 0.7rem; color: var(--accent);">${parsed.account || 'N/A'}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Remarks</div>
                        <div class="parse-value" style="font-size: 0.7rem;">${parsed.remarks || 'N/A'}</div>
                    </div>
                    <div class="parse-item">
                        <div class="parse-label">Confidence</div>
                        <div class="parse-value" style="color: ${parsed.confidence >= 70 ? 'var(--success)' : parsed.confidence >= 50 ? 'var(--warning)' : 'var(--danger)'}">${parsed.confidence}%</div>
                    </div>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: rgba(6,182,212,0.1); border-radius: var(--radius-sm); font-size: 0.7rem;">
                    <strong>Analysis:</strong> ${getAnalysisMessage(parsed)}
                </div>
            `;
        }
        
        function getAnalysisMessage(parsed) {
            const messages = [];
            
            if (parsed.confidence >= 80) {
                messages.push('‚úÖ High confidence parsing');
            } else if (parsed.confidence >= 60) {
                messages.push('‚ö†Ô∏è Medium confidence - verify details');
            } else {
                messages.push('‚ùå Low confidence - manual review needed');
            }
            
            if (parsed.amount && parsed.amount > 0) {
                messages.push('üí∞ Amount detected');
            }
            
            if (parsed.type) {
                messages.push(`üìä ${parsed.type === 'credit' ? 'Income' : 'Expense'} identified`);
            }
            
            if (parsed.bank !== 'Unknown') {
                messages.push('üè¶ Bank recognized');
            }
            
            if (parsed.account) {
                messages.push('üè¶ Account detected');
            }
            
            if (parsed.remarks) {
                messages.push('üìù Remarks extracted');
            }
            
            return messages.join(' ‚Ä¢ ');
        }
        
        async function testProcessSMS() {
            const text = document.getElementById('testSmsInput').value;
            if (!text.trim()) return showAlert('Enter SMS to test', 'error');
            
            const parsed = parseSMS(text);
            if (!parsed?.amount) return showAlert('Could not parse SMS', 'error');
            if (!parsed.type) parsed.type = 'debit';
            
            await addTransaction(parsed);
            document.getElementById('testSmsInput').value = '';
            document.getElementById('testParsePreview').classList.remove('show');
            showAlert(`‚úÖ Test successful: ${parsed.type === 'credit' ? 'Income' : 'Expense'}: Rs. ${parsed.amount.toLocaleString()}`, 'success');
        }
        
        function clearTest() {
            document.getElementById('testSmsInput').value = '';
            document.getElementById('testExample').value = '';
            document.getElementById('testParsePreview').classList.remove('show');
        }

        // ============================================
        // TABLE VIEW FUNCTIONS
        // ============================================
        
        // Test function to manually trigger table view
        function testTableView() {
            console.log('Testing table view...');
            const tableBtn = document.querySelector('button[onclick*="tab-table"]');
            if (tableBtn) {
                console.log('Table button found, clicking...');
                tableBtn.click();
            } else {
                console.log('Table button not found, trying manual switch...');
                switchTab(document.querySelector('.tab-btn'), 'tab-table');
            }
        }
        
        function renderTable() {
            console.log('renderTable called, transactions:', state.transactions.length); // Debug line
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('tableEmptyState');
            const search = (document.getElementById('tableSearchInput')?.value || '').toLowerCase();
            const filter = document.getElementById('tableFilterType')?.value || 'all';
            
            console.log('Table elements found:', { tbody: !!tbody, emptyState: !!emptyState }); // Debug line
            
            if (!tbody || !emptyState) {
                console.error('Table elements not found!'); // Debug line
                return;
            }
            
            let filtered = state.transactions;
            if (filter !== 'all') filtered = filtered.filter(t => t.type === filter);
            if (search) filtered = filtered.filter(t => 
                (t.bank + (t.remarks || '') + (t.account || '') + (t.rawSMS || '')).toLowerCase().includes(search)
            );
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            console.log('Filtered transactions:', filtered.length); // Debug line
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tbody.innerHTML = filtered.map(t => `
                <tr>
                    <td style="font-size: 0.7rem; color: var(--text-secondary);">${formatDate(new Date(t.date))}</td>
                    <td style="font-weight: 500;">${t.bank}</td>
                    <td style="font-family: monospace; font-size: 0.7rem; color: var(--accent);">${t.account || 'N/A'}</td>
                    <td>
                        <span style="padding: 0.2rem 0.4rem; border-radius: var(--radius-sm); font-size: 0.65rem; font-weight: 600; 
                                     ${t.type === 'credit' ? 'background: rgba(16, 185, 129, 0.1); color: var(--success);' : 'background: rgba(239, 68, 68, 0.1); color: var(--danger);'}">
                            ${t.type === 'credit' ? '‚¨áÔ∏è Income' : '‚¨ÜÔ∏è Expense'}
                        </span>
                    </td>
                    <td style="text-align: right; font-weight: 600; color: ${t.type === 'credit' ? 'var(--success)' : 'var(--danger)'};">
                        ${t.type === 'credit' ? '+' : '-'}Rs.${t.amount.toLocaleString()}
                    </td>
                    <td style="font-size: 0.7rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${t.remarks || 'N/A'}
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-ghost btn-icon" onclick="editTransactionFromTable('${t.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-ghost btn-icon" onclick="confirmDeleteFromTable('${t.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function editTransactionFromTable(id) {
            const txn = state.transactions.find(t => t.id === id);
            if (!txn) return;
            
            // Store original for learning
            const original = { ...txn };
            
            document.getElementById('editId').value = id;
            document.getElementById('editAmount').value = txn.amount;
            document.getElementById('editType').value = txn.type;
            document.getElementById('editBank').value = txn.bank;
            document.getElementById('editDate').value = txn.date_bs || '';
            document.getElementById('editAccount').value = txn.account || '';
            document.getElementById('editRemarks').value = txn.remarks || '';
            
            // Store original for learning comparison
            window._editOriginal = original;
            
            openModal('editModal');
        }
        
        function confirmDeleteFromTable(id) {
            const txn = state.transactions.find(t => t.id === id);
            if (!txn) return;
            
            showConfirm(`Delete this transaction?<br><br>
                <strong>${txn.type === 'credit' ? 'Income' : 'Expense'}: Rs.${txn.amount.toLocaleString()}</strong><br>
                <small>${txn.bank} - ${formatDate(new Date(txn.date))}</small>`, async () => {
                await deleteTransaction(id);
                renderTable();
                showAlert('Transaction deleted', 'success');
            });
        }
        
        function confirmClearAllTransactions() {
            if (state.transactions.length === 0) {
                showAlert('No transactions to delete', 'warning');
                return;
            }
            
            showConfirm(`Delete ALL ${state.transactions.length} transactions? This cannot be undone!`, async () => {
                await DB.clear(STORES.TRANSACTIONS);
                state.transactions = [];
                updateUI();
                renderTable();
                showAlert('All transactions deleted', 'success');
            });
        }
        
        // Enhanced saveEdit with learning confirmation
        async function saveEditWithLearning() {
            const id = document.getElementById('editId').value;
            const original = window._editOriginal;
            
            const updates = {
                amount: parseFloat(document.getElementById('editAmount').value),
                type: document.getElementById('editType').value,
                bank: document.getElementById('editBank').value,
                date_bs: document.getElementById('editDate').value,
                account: document.getElementById('editAccount').value || null,
                remarks: document.getElementById('editRemarks').value || null
            };
            
            // Check if there are meaningful changes
            const hasChanges = 
                original.amount !== updates.amount ||
                original.type !== updates.type ||
                original.bank !== updates.bank ||
                original.account !== updates.account ||
                original.remarks !== updates.remarks;
            
            if (!hasChanges) {
                closeModal('editModal');
                return;
            }
            
            // If changes detected, confirm learning
            const changes = [];
            if (original.type !== updates.type) changes.push(`Type: ${original.type} ‚Üí ${updates.type}`);
            if (original.bank !== updates.bank) changes.push(`Bank: ${original.bank} ‚Üí ${updates.bank}`);
            if (original.account !== updates.account) changes.push(`Account: ${original.account || 'N/A'} ‚Üí ${updates.account || 'N/A'}`);
            if (original.remarks !== updates.remarks) changes.push(`Remarks: ${original.remarks || 'N/A'} ‚Üí ${updates.remarks || 'N/A'}`);
            
            if (changes.length > 0) {
                showConfirm(`Learn from these changes?<br><br>${changes.join('<br>')}`, async () => {
                    const result = await updateTransaction(id, updates);
                    
                    if (result) {
                        await learnFromEdit(result.original, result.updated);
                        closeModal('editModal');
                        updateUI();
                        renderTable();
                        showAlert('‚úì Saved & Learned!', 'success');
                    }
                });
            } else {
                // Just save without learning if no meaningful changes
                const result = await updateTransaction(id, updates);
                if (result) {
                    closeModal('editModal');
                    updateUI();
                    renderTable();
                    showAlert('‚úì Saved!', 'success');
                }
            }
        }

        // ============================================
        // NAVIGATION FUNCTIONS
        // ============================================
        
        function openTracker() {
            // Open the main tracker app
            window.open('./index.html', '_blank');
        }

        function updateTransactionsInTracker() {
            try {
                // Store all current transactions in localStorage for the main app to process
                const allTransactions = state.transactions || [];
                
                if (allTransactions.length === 0) {
                    showAlert('No transactions found to update', 'warning');
                    return;
                }
                
                // Convert transactions to tracker format and store in localStorage
                const trackerTransactions = allTransactions.map(transaction => {
                    return {
                        date_bs: convertToBSDate(transaction.date),
                        category: mapBankTransactionToCategory(transaction),
                        currency: 'NPR',
                        amount: transaction.amount,
                        description: `${transaction.bank || 'Unknown'}: ${transaction.remarks || 'Bank Transaction'}`,
                        source: 'sms_parser',
                        sourceId: transaction.id,
                        bank: transaction.bank,
                        account: transaction.account,
                        type: transaction.type,
                        createdAt: transaction.createdAt || new Date().toISOString()
                    };
                });
                
                // Store in localStorage for the main app to pick up
                const existingPending = JSON.parse(localStorage.getItem('pendingTrackerTransactions') || '[]');
                const allPendingTransactions = [...existingPending, ...trackerTransactions];
                localStorage.setItem('pendingTrackerTransactions', JSON.stringify(allPendingTransactions));
                
                showAlert(`üìä Prepared ${allTransactions.length} transactions for tracker update. Open the tracker app and click "üîÑ Process SMS" to import.`, 'success');
                
                // Optionally open the tracker app automatically
                setTimeout(() => {
                    if (confirm('Open the tracker app to complete the import?')) {
                        openTracker();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error preparing transactions for tracker:', error);
                showAlert('Error preparing transactions for tracker', 'error');
            }
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            const SW = `
                const CACHE = 'sms-idb-v1';
                self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
                self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => new Response('Offline'))));
                });
            `;
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([SW], { type: 'application/javascript' }))).catch(() => {});
        }
        
        // ============================================
        // IMPORT/EXPORT FUNCTIONS
        // ============================================
        
        // Dropdown toggle function
        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            const allMenus = document.querySelectorAll('.dropdown-menu');
            
            // Close all other menus
            allMenus.forEach(m => {
                if (m.id !== menuId) {
                    m.style.display = 'none';
                }
            });
            
            // Toggle current menu
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        // Close dropdowns when clicking outside
        // Initialize Nepali date pickers
        setTimeout(() => {
            const manualDateInput = document.getElementById('manualDate');
            const editDateInput = document.getElementById('editDate');
            
            if (manualDateInput && !manualDateInput.hasAttribute('data-nepali-picker')) {
                new NepaliDatePicker(manualDateInput);
            }
            
            if (editDateInput && !editDateInput.hasAttribute('data-nepali-picker')) {
                new NepaliDatePicker(editDateInput);
            }
        }, 100);
        
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });
        
        // Export SMS Data
        async function exportSMSData(format = 'json') {
            try {
                showAlert('üì§ Preparing export...', 'info');
                
                const transactions = await getAllTransactions();
                const patterns = await getAllPatterns();
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    version: '1.0.0',
                    data: {
                        transactions: transactions,
                        patterns: patterns
                    }
                };
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                
                if (format === 'excel') {
                    await exportAsExcel(exportData, `sms_parser_export_${timestamp}.xlsx`);
                } else {
                    await exportAsJSON(exportData, `sms_parser_export_${timestamp}.json`);
                }
                
                showAlert(`‚úÖ Export completed successfully! (${format.toUpperCase()})`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('‚ùå Export failed: ' + error.message, 'error');
            }
        }
        
        // Import SMS Data
        async function importSMSData(format, fileInput) {
            try {
                const file = fileInput.files[0];
                if (!file) {
                    return;
                }
                
                showAlert('üì• Reading file...', 'info');
                
                let importData;
                if (format === 'excel') {
                    importData = await readExcelFile(file);
                } else {
                    importData = await readJSONFile(file);
                }
                
                if (!importData.data) {
                    throw new Error('Invalid file format - missing data section');
                }
                
                let importCount = 0;
                
                // Import transactions
                if (importData.data.transactions && Array.isArray(importData.data.transactions)) {
                    for (const transaction of importData.data.transactions) {
                        try {
                            await addTransaction(transaction);
                            importCount++;
                        } catch (error) {
                            console.warn('Failed to import transaction:', transaction, error);
                        }
                    }
                }
                
                // Import patterns
                if (importData.data.patterns && Array.isArray(importData.data.patterns)) {
                    for (const pattern of importData.data.patterns) {
                        try {
                            await savePatternToDB(pattern);
                            importCount++;
                        } catch (error) {
                            console.warn('Failed to import pattern:', pattern, error);
                        }
                    }
                }
                
                // Refresh displays
                state.transactions = await DB.getAll(STORES.TRANSACTIONS);
                state.patterns = await DB.getAll(STORES.PATTERNS);
                updateUI();
                renderTable();
                updateStorageInfo();
                
                showAlert(`‚úÖ Import completed! ${importCount} items imported. (${format.toUpperCase()})`, 'success');
                
            } catch (error) {
                console.error('Import error:', error);
                showAlert('‚ùå Import failed: ' + error.message, 'error');
            }
            
            // Reset file input
            fileInput.value = '';
        }
        
        // Export as JSON
        async function exportAsJSON(data, filename) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            downloadFile(blob, filename);
        }
        
        // Export as Excel
        async function exportAsExcel(data, filename) {
            try {
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add transactions sheet
                if (data.data.transactions && data.data.transactions.length > 0) {
                    const transactionsWS = XLSX.utils.json_to_sheet(data.data.transactions);
                    XLSX.utils.book_append_sheet(wb, transactionsWS, 'Transactions');
                }
                
                // Add patterns sheet
                if (data.data.patterns && data.data.patterns.length > 0) {
                    const patternsWS = XLSX.utils.json_to_sheet(data.data.patterns);
                    XLSX.utils.book_append_sheet(wb, patternsWS, 'Patterns');
                }
                
                // Add metadata sheet
                const metadataWS = XLSX.utils.json_to_sheet([
                    { Property: 'Export Date', Value: data.exportDate },
                    { Property: 'Version', Value: data.version },
                    { Property: 'Total Transactions', Value: data.data.transactions ? data.data.transactions.length : 0 },
                    { Property: 'Total Patterns', Value: data.data.patterns ? data.data.patterns.length : 0 }
                ]);
                XLSX.utils.book_append_sheet(wb, metadataWS, 'Metadata');
                
                // Write file
                XLSX.writeFile(wb, filename);
            } catch (error) {
                console.error('Excel export error:', error);
                throw new Error('Excel export failed: ' + error.message);
            }
        }
        
        // Read JSON file
        async function readJSONFile(file) {
            try {
                const text = await file.text();
                return JSON.parse(text);
            } catch (error) {
                console.error('JSON read/parse error:', error);
                throw error;
            }
        }
        
        // Read Excel file
        async function readExcelFile(file) {
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                const importData = {
                    exportDate: new Date().toISOString(),
                    version: '1.0.0',
                    data: {
                        transactions: [],
                        patterns: []
                    }
                };
                
                // Read transactions sheet
                if (workbook.Sheets['Transactions']) {
                    const transactions = XLSX.utils.sheet_to_json(workbook.Sheets['Transactions']);
                    importData.data.transactions = transactions;
                }
                
                // Read patterns sheet
                if (workbook.Sheets['Patterns']) {
                    const patterns = XLSX.utils.sheet_to_json(workbook.Sheets['Patterns']);
                    importData.data.patterns = patterns;
                }
                
                return importData;
            } catch (error) {
                console.error('Excel import error:', error);
                throw new Error('Excel import failed: ' + error.message);
            }
        }
        
        // Download file helper
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Helper function to get all transactions
        async function getAllTransactions() {
            if (!DB) {
                throw new Error('Database not initialized');
            }
            try {
                return await DB.getAll(STORES.TRANSACTIONS);
            } catch (error) {
                console.error('Error fetching transactions:', error);
                throw error;
            }
        }
        
        // Helper function to get all patterns
        async function getAllPatterns() {
            if (!DB) {
                throw new Error('Database not initialized');
            }
            try {
                return await DB.getAll(STORES.PATTERNS);
            } catch (error) {
                console.error('Error fetching patterns:', error);
                throw error;
            }
        }
    </script>
</body>
</html>